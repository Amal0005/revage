<%- include("../../views/partials/user/header") %>

<style>
/* Modern Wishlist Styling */
.main {
    min-height: 100vh;
    background-color: #f9fafb;
    padding: 0;
}

/* Header & Breadcrumb */
.page-header {
    background: linear-gradient(to right, #fff, #f8f9fa);
    padding: 1.5rem 0;
    border-bottom: 1px solid #edf2f7;
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
    list-style: none;
}

.breadcrumb li {
    display: flex;
    align-items: center;
    color: #4a5568;
    font-size: 0.875rem;
}

.breadcrumb li:not(:last-child)::after {
    content: '/';
    margin-left: 0.5rem;
    color: #cbd5e0;
}

.breadcrumb a {
    color: #2d3748;
    text-decoration: none;
    transition: color 0.2s;
}

.breadcrumb a:hover {
    color: #000;
}

/* Wishlist Header */
.wishlist-header {
    text-align: center;
    margin-bottom: 2rem;
}

.wishlist-header h1 {
    font-size: 2rem;
    color: #1a202c;
    margin-bottom: 0.5rem;
}

.wishlist-count {
    color: #718096;
    font-size: 0.875rem;
}

/* Table Styling */
.wishlist-table {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.table th {
    background: #1a202c;
    color: #fff;
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 1rem 1.5rem;
}

.table td {
    padding: 1.5rem;
    vertical-align: middle;
    border-bottom: 1px solid #edf2f7;
}

/* Product Information */
.product-cell {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.product-image {
    width: 80px;
    height: 80px;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid #edf2f7;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-image:hover img {
    transform: scale(1.05);
}

.product-info {
    flex: 1;
}

.product-name {
    font-weight: 500;
    color: #2d3748;
    text-decoration: none;
    font-size: 1rem;
    margin-bottom: 0.25rem;
    display: block;
}

.product-name:hover {
    color: #000;
}

.product-meta {
    color: #718096;
    font-size: 0.875rem;
}

/* Price Column */
.price-cell {
    font-weight: 600;
    color: #1a202c;
}

.original-price {
    color: #a0aec0;
    text-decoration: line-through;
    margin-left: 0.5rem;
    font-size: 0.875rem;
}

/* Stock Status */
.stock-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.in-stock {
    background: #f0fff4;
    color: #2f855a;
}

.out-stock {
    background: #fff5f5;
    color: #dc3545;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
}

.btn-cart {
    background: #000;
    color: #fff;
    opacity: 1;
    transition: opacity 0.2s;
}

.btn-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-cart:not(:disabled):hover {
    opacity: 0.9;
}

.btn-remove {
    background: #fff;
    color: #2d3748;
    border: 1px solid #e2e8f0;
}

.btn-remove:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
}

/* Quantity Selector */
.quantity-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 4px;
    width: fit-content;
}

.quantity-btn {
    background-color: #f3f4f6;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
}

.quantity-btn:hover {
    background-color: #e5e7eb;
}

.quantity-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.quantity-value {
    min-width: 30px;
    text-align: center;
    font-size: 14px;
    font-weight: 500;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-icon {
    font-size: 3rem;
    color: #a0aec0;
    margin-bottom: 1.5rem;
}

.empty-title {
    font-size: 1.5rem;
    color: #2d3748;
    margin-bottom: 0.5rem;
}

.empty-text {
    color: #718096;
    margin-bottom: 1.5rem;
}

.btn-shop {
    background: #000;
    color: #fff;
    padding: 0.75rem 2rem;
}

.btn-shop:hover {
    background: #2d3748;
}

/* Responsive Design */
@media (max-width: 768px) {
    .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .product-cell {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .action-buttons {
        flex-direction: column;
        width: 100%;
    }

    .btn {
        width: 100%;
    }

    .table td {
        padding: 1rem;
    }
}

.wishlist-section {
    padding: 2rem 0;
    background-color: #f9fafb;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.wishlist-header {
    margin-bottom: 2rem;
}

.table {
    width: 100%;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.table th {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 600;
}

.table td {
    padding: 1rem;
    border-bottom: 1px solid #e2e8f0;
}

.product-cell {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.product-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
}

.product-info {
    flex: 1;
}

.product-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.product-category {
    color: #666;
    font-size: 0.875rem;
}

.price-cell {
    font-weight: 600;
}

.sale-price {
    color: #e63946;
    margin-right: 0.5rem;
}

.regular-price {
    color: #666;
    text-decoration: line-through;
}

.stock-status {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.in-stock {
    background: #e6ffe6;
    color: #008000;
}

.out-of-stock {
    background: #ffe6e6;
    color: #cc0000;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.add-to-cart-btn {
    padding: 0.5rem 1rem;
    background: #000;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.add-to-cart-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.remove-btn {
    padding: 0.5rem;
    background: none;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    color: #666;
    cursor: pointer;
}

.remove-btn:hover {
    background: #f8f9fa;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.empty-icon {
    font-size: 3rem;
    color: #cbd5e0;
    margin-bottom: 1rem;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.empty-text {
    color: #666;
    margin-bottom: 1.5rem;
}

.btn-shop {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #000;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    transition: background 0.2s;
}

.btn-shop:hover {
    background: #333;
}

@media (max-width: 768px) {
    .table-responsive {
        overflow-x: auto;
    }
    
    .product-cell {
        min-width: 200px;
    }
}
</style>

<main class="main">
    <!-- Breadcrumb -->
    <div class="page-header">
        <div class="container">
            <ul class="breadcrumb">
                <li><a href="/">Home</a></li>
                <li>Wishlist</li>
            </ul>
        </div>
    </div>

    <section class="wishlist-section py-8">
        <div class="container">
            <div class="wishlist-header">
                <h1 class="text-2xl font-bold mb-4">My Wishlist</h1>
                <% if(wishlist && wishlist.length > 0) { %>
                    <p class="text-gray-600">(<%= wishlist.length %> items)</p>
                <% } %>
            </div>

            <div class="wishlist-content">
                <% if(wishlist && wishlist.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Stock Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% wishlist.forEach(function(product) { %>
                                    <tr id="wishlist-item-<%= product.wishlistItemId %>">
                                        <td>
                                            <div class="product-cell">
                                                <img 
                                                    src="/uploads/product-images/<%= product.productImage ? product.productImage[0] : 'placeholder.jpg' %>" 
                                                    alt="<%= product.productName %>" 
                                                    class="product-image"
                                                    onerror="this.src='/assets/imgs/placeholder.jpg'"
                                                >
                                                <div class="product-info">
                                                    <h3 class="product-name"><%= product.productName %></h3>
                                                    <p class="product-category"><%= product.category ? product.category.name : 'Uncategorized' %></p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="price-cell">
                                                <% if (product.salePrice && product.salePrice < product.regularPrice) { %>
                                                    <span class="sale-price">₹<%= product.salePrice %></span>
                                                    <span class="regular-price">₹<%= product.regularPrice %></span>
                                                <% } else { %>
                                                    <span class="regular-price">₹<%= product.regularPrice %></span>
                                                <% } %>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="stock-status <%= product.stock > 0 ? 'in-stock' : 'out-of-stock' %>">
                                                <%= product.stock > 0 ? 'In Stock' : 'Out of Stock' %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button onclick="addToCart('<%= product._id %>')" class="add-to-cart-btn" <%= product.stock <= 0 ? 'disabled' : '' %>>
                                                    Add to Cart
                                                </button>
                                                <button onclick="removeFromWishlistHandler(this, '<%= product.wishlistItemId %>')" class="remove-btn">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <i class="far fa-heart empty-icon"></i>
                        <h3 class="empty-title">Your Wishlist is Empty</h3>
                        <p class="empty-text">Add items that you like to your wishlist</p>
                        <a href="/shop" class="btn-shop">Continue Shopping</a>
                    </div>
                <% } %>
            </div>
        </div>
    </section>
</main>

<script>
function addToCart(productId) {
    // Show loading state
    Swal.fire({
        title: 'Adding to Cart...',
        text: 'Please wait',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });

    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId, quantity: 1 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status) {
            Swal.fire({
                icon: 'success',
                title: 'Added to Cart!',
                text: 'Would you like to remove this item from your wishlist?',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove it',
                cancelButtonText: 'No, keep it',
                confirmButtonColor: '#000',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    removeFromWishlistHandler(
                        document.querySelector(`#wishlist-item-${productId} .remove-btn`),
                        productId
                    );
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: data.message || 'Could not add item to cart',
                confirmButtonColor: '#000',
                confirmButtonText: 'OK'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Something went wrong',
            text: 'An error occurred while adding to cart. Please try again.',
            confirmButtonColor: '#000',
            confirmButtonText: 'OK'
        });
    });
}

function removeFromWishlistHandler(button, wishlistItemId) {
    Swal.fire({
        title: 'Remove from Wishlist?',
        text: "This item will be removed from your wishlist",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#000',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, remove it',
        cancelButtonText: 'No, keep it',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading state
            Swal.fire({
                title: 'Removing...',
                text: 'Please wait',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('/wishlist/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ wishlistItemId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    // Remove the item from DOM
                    const row = button.closest('tr');
                    if (row) {
                        row.remove();
                        
                        // Check if wishlist is empty
                        const remainingItems = document.querySelectorAll('tr[id^="wishlist-item-"]');
                        if (remainingItems.length === 0) {
                            const tableContainer = document.querySelector('.wishlist-content');
                            if (tableContainer) {
                                tableContainer.innerHTML = `
                                    <div class="empty-state">
                                        <i class="far fa-heart empty-icon"></i>
                                        <h3 class="empty-title">Your Wishlist is Empty</h3>
                                        <p class="empty-text">Add items that you like to your wishlist</p>
                                        <a href="/shop" class="btn-shop">Continue Shopping</a>
                                    </div>
                                `;
                            }
                        }
                    }
                    Swal.fire({
                        icon: 'success',
                        title: 'Removed!',
                        text: 'Item has been removed from your wishlist',
                        confirmButtonColor: '#000',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Could not remove item from wishlist',
                        confirmButtonColor: '#000',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Something went wrong',
                    text: 'An error occurred while removing the item',
                    confirmButtonColor: '#000',
                    confirmButtonText: 'OK'
                });
            });
        }
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<%- include("../../views/partials/user/footer") %>
